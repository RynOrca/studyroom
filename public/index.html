<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯è‡ªä¹ å®¤ - ä¸“æ³¨æ¯ä¸€åˆ»</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰çš„è‰²å½©å’ŒåŸºç¡€å¸ƒå±€ï¼Œæ–°å¢å³ä¸Šè§’çŠ¶æ€å’Œåˆ—è¡¨æ ·å¼ */
        :root { --bg-color: #f0f2f5; --panel-bg: #ffffff; --primary-color: #52c41a; --primary-hover: #73d13d; --danger-color: #ff4d4f; --text-main: #262626; --text-secondary: #8c8c8c; --border-color: #f0f0f0; --radius: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ====== æ–°å¢ï¼šå³ä¸Šè§’çŠ¶æ€æ  ====== */
        .top-bar { position: absolute; top: 20px; right: 20px; z-index: 20; display: flex; gap: 10px; }
        .stat-badge { background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 5px;}
        .host-badge { background: #faad14; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; font-weight: bold;}

        /* ====== è§†é¢‘åŒºåŸŸ ====== */
    .video-container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #1f1f1f; position: relative; overflow: hidden; }

    /* è§†é¢‘ä¸»åŒºä¸ä¾§æ å¸ƒå±€ï¼ˆä¸»è§†é¢‘ + å³ä¾§æœ€å¤š 3 äººï¼‰ */
    .video-grid { display: flex; gap: 20px; width: 100%; height: 100%; max-width: 1400px; align-items: flex-start; justify-content: center; }

    /* å•ä¸ªè§†é¢‘ç›’å­åŸºç¡€å°ºå¯¸ï¼ˆé»˜è®¤å°å°ºå¯¸ï¼‰ */
    .video-box { background: #000; border-radius: var(--radius); overflow: hidden; position: relative; cursor: pointer; border: 2px solid transparent; transition: all 0.25s ease; display: flex; }
    .video-box video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .video-label { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 4px;}

    /* ä¸»è§†é¢‘ï¼ˆæ”¾å¤§ï¼‰ */
    .video-box.large { width: 1024px; height: 600px; flex: 0 0 auto; }

    /* é»˜è®¤ä¸»è§†é¢‘ï¼ˆæœªæ”¾å¤§çš„â€œä¸»â€ï¼‰/æœ¬åœ°ç¼©å°å°ºå¯¸ */
    .video-box.default-main { width: 600px; height: 400px; flex: 0 0 auto; }

    /* å³ä¾§ä¾§æ å®¹å™¨ */

    .video-sidebar { width: 360px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; align-self: flex-start; }

    /* ä¾§æ å†…æ¯ä¸ªè§†é¢‘å®½åº¦å æ»¡ï¼ˆé«˜åº¦ç”± JS è®¡ç®—ï¼Œä½¿ä¾§æ é«˜åº¦ç­‰äºä¸»è§†é¢‘é«˜åº¦ï¼›è¶…å‡ºæ—¶å‡ºç°æ»šåŠ¨ï¼‰ */
    .video-sidebar .video-box { width: 100%; min-height: 80px; }

    /* å½“ä¾§æ ä¸ºç©ºæ—¶éšè— */
    .video-sidebar.empty { display: none; }
        
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 50px; backdrop-filter: blur(10px); z-index: 11;}
        .controls button { padding: 10px 20px; border-radius: 50px; border: none; cursor: pointer; background: rgba(255,255,255,0.2); color: white; transition: 0.3s; }
        .controls button.active { background: var(--primary-color); }
        .controls button.btn-danger.active { background: var(--danger-color); }

        /* ====== åº•éƒ¨åŠŸèƒ½åŒº ====== */
        .bottom-panels { display: flex; height: 380px; border-top: 1px solid var(--border-color); background: var(--panel-bg); z-index: 5;}
        .panel { flex: 1; padding: 20px 25px; border-right: 1px solid var(--border-color); overflow-y: auto; display: flex; flex-direction: column; }
        .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .panel h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input[type="text"], input[type="number"] { flex: 1; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; }
        button.styled-btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; background: var(--primary-color); color: white; }
        button.styled-btn.secondary { background: #f5f5f5; color: var(--text-main); border: 1px solid #d9d9d9; }
        button.styled-btn.danger { background: #fff1f0; color: var(--danger-color); border: 1px solid #ffccc7; }
        button:disabled { opacity: 0.5; cursor: not-allowed !important; }

        /* ä»»åŠ¡åŒº */
        #listsContainer { flex: 1; overflow-y: auto; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border-color); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-secondary); }

        /* è®¡æ—¶åŒº */
        .timer-display { font-size: 56px; font-weight: 700; color: var(--primary-color); margin: 15px 0; text-align: center; }
        .timer-status-bar { width: 100%; text-align: center; padding: 6px; border-radius: 4px; background: #f5f5f5; margin-bottom: 15px; font-size: 13px;}
        .timer-settings { background: #fafafa; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        /* èŠå¤©å®¤åŒº */
        .chat-messages { flex: 1; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 12px; border-radius: 8px; background: #fafafa; display: flex; flex-direction: column; gap: 10px;}
        .message { font-size: 14px; padding: 8px 12px; border-radius: 8px; background: white; border: 1px solid var(--border-color); align-self: flex-start; max-width: 90%; word-wrap: break-word;}
        .message.self { align-self: flex-end; background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .message .msg-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;}
        .message.self .msg-meta { color: rgba(255,255,255,0.8); text-align: right;}
        
        /* åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ */
        .user-list { font-size: 12px; margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
        .user-tag { background: #e6f7ff; color: #1890ff; padding: 2px 8px; border-radius: 12px; border: 1px solid #91d5ff; cursor: pointer;}
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="stat-badge" id="hostStatusBadge" style="display:none; background: #faad14;">ğŸ‘‘ æˆ‘æ˜¯ä¸»æŒäºº</div>
        <div class="stat-badge">ğŸ‘¥ åœ¨çº¿äººæ•°: <span id="userCountDisplay">1</span></div>
    </div>

    <div class="video-container">
        <div class="video-grid" id="videoGrid">
            <div class="video-box" id="localVideoBox" onclick="togglePin('localVideoBox')">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-label"><span>æˆ‘ (æœªå¼€å¯)</span></div>
            </div>
        </div>
        
        <div class="controls">
            <button id="btnMic" onclick="toggleMic()">ğŸ¤ å¼€å¯éº¦å…‹é£</button>
            <button id="btnCam" onclick="toggleCam()">ğŸ“· å¼€å¯æ‘„åƒå¤´</button>
            <button id="btnScreen" onclick="toggleScreenShare()" class="btn-danger">ğŸ’» å…±äº«å±å¹•</button>
        </div>
    </div>

    <div class="bottom-panels">
        <div class="panel" id="taskPanel">
            <div class="panel-header"><h3>ğŸ“‹ ä»»åŠ¡æ¸…å•</h3></div>
            <div class="input-group">
                <input type="text" id="newListInput" placeholder="è¾“å…¥æ¸…å•åç§°...">
                <button class="styled-btn" onclick="createList()">æ–°å»º</button>
            </div>
            <div id="listsContainer"></div>
        </div>

        <div class="panel" id="timerPanel">
            <div class="panel-header"><h3>â±ï¸ ä¸“æ³¨è®¡æ—¶</h3></div>
            <div class="timer-display" id="timeDisplay">25:00</div>
            <div class="timer-status-bar" id="timerStatus">å‡†å¤‡å°±ç»ª</div>
            
            <div class="timer-settings">
                <div style="display: flex; justify-content: space-between;">
                    <span>ä¸“æ³¨(åˆ†): <input type="number" id="focusTime" value="25" style="width:50px"></span>
                    <span>ä¼‘æ¯(åˆ†): <input type="number" id="breakTime" value="5" style="width:50px"></span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="styled-btn" onclick="startPomodoro()">ç•ªèŒ„é’Ÿ</button>
                    <button class="styled-btn secondary" onclick="startStopwatch()">æ­£è®¡æ—¶</button>
                    <button class="styled-btn" id="btnPause" onclick="togglePauseTimer()" style="display:none; background:#faad14;">æš‚åœ</button>
                    <button class="styled-btn danger" onclick="stopTimer()">åœæ­¢</button>
                </div>
            </div>
        </div>

        <div class="panel" id="reflectionPanel">
            <div class="panel-header">
                <h3>ğŸ’¬ èŠå¤©å®¤</h3>
                <button id="hostChatToggleBtn" class="styled-btn danger" style="display:none; padding: 4px 8px; font-size: 12px;" onclick="toggleRoomChat()">ç¦è¨€å…¨å‘˜</button>
            </div>
            <div class="user-list" id="userListContainer"></div>
            <div class="chat-messages" id="chatBox"></div>
            <div class="input-group">
                <input type="text" id="reflectionInput" placeholder="å‘é€æ¶ˆæ¯...">
                <button class="styled-btn" id="btnSendChat" onclick="sendReflection()">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        const ROOM_ID = 'default_study_room';
    let socket;
    let myUserId;
    let isHost = false;
    let roomUsers = [];

    // å¸ƒå±€çŠ¶æ€ï¼šå½“å‰ä¸»çª— IDï¼ˆbox çš„ idï¼Œä¾‹å¦‚ localVideoBox æˆ– box_<userId>ï¼‰
    let currentMainId = 'localVideoBox';
    // æ˜¯å¦å¤„äºæ”¾å¤§æ¨¡å¼ï¼ˆä¸»çª—ä¸ºæ”¾å¤§ 1024x600ï¼‰ï¼Œfalse è¡¨ç¤ºé»˜è®¤ä¸»çª—ä¸º 600x400
    let isLargeMode = false;

        // WebRTC çŠ¶æ€
        let peerConnections = {}; 
        let localStream = null;
        let cameraTrack = null; // å•ç‹¬ä¿å­˜æ‘„åƒå¤´è½¨é“ä»¥ä¾¿æ¢å¤
        let isCamOpen = false;
        let isMicOpen = false;
        let isSharingScreen = false; 

    window.onload = () => { initSocket(); createList('ä»Šæ—¥ç›®æ ‡'); arrangeLayout(currentMainId, isLargeMode); };

        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                myUserId = socket.id;
                socket.emit('join_room', ROOM_ID);
            });

            // ====== æ ¸å¿ƒæ›´æ–°ï¼šç›‘å¬æˆ¿é—´çŠ¶æ€åŒæ­¥ ======
            socket.on('room_update', (data) => {
                roomUsers = data.users;
                document.getElementById('userCountDisplay').innerText = roomUsers.length;
                
                // 1. åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯ä¸»æŒäºº
                isHost = (data.host === myUserId);
                document.getElementById('hostStatusBadge').style.display = isHost ? 'flex' : 'none';
                document.getElementById('hostChatToggleBtn').style.display = isHost ? 'block' : 'none';
                
                // 2. æ¸²æŸ“åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ (ç‚¹å‡»å¯è½¬ç§»ä¸»æŒäºº)
                renderUserList(data.host);

                // 3. å¤„ç†èŠå¤©å®¤ç¦è¨€é€»è¾‘
                const chatInput = document.getElementById('reflectionInput');
                const chatBtn = document.getElementById('btnSendChat');
                const toggleBtn = document.getElementById('hostChatToggleBtn');
                
                if (!data.chatEnabled && !isHost) {
                    chatInput.disabled = true;
                    chatBtn.disabled = true;
                    chatInput.placeholder = "ä¸»æŒäººå·²å…³é—­èŠå¤©å®¤";
                } else {
                    chatInput.disabled = false;
                    chatBtn.disabled = false;
                    chatInput.placeholder = "å‘é€æ¶ˆæ¯...";
                }
                
                if (isHost) {
                    toggleBtn.innerText = data.chatEnabled ? "ç¦è¨€å…¨å‘˜" : "è§£é™¤ç¦è¨€";
                    toggleBtn.className = data.chatEnabled ? "styled-btn danger" : "styled-btn";
                }
            });

            socket.on('chat_message', (msgData) => {
                appendMessage(msgData.userName, msgData.message, msgData.time, false);
            });

            // WebRTC ä¿¡ä»¤ (ä¸å˜)
            socket.on('user_joined', async (newUserId) => {
                const pc = createPeerConnection(newUserId);
                if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('offer', { target: newUserId, caller: myUserId, sdp: offer });
            });
            socket.on('offer', async (data) => {
                const pc = createPeerConnection(data.caller);
                await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('answer', { target: data.caller, serval: myUserId, sdp: answer });
            });
            socket.on('answer', async (data) => {
                const pc = peerConnections[data.serval];
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            });
            socket.on('ice-candidate', async (data) => {
                const pc = peerConnections[data.from];
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            });
            socket.on('user_left', (userId) => { closePeerConnection(userId); });
        }

        // ====== æƒé™ç®¡ç†ï¼šç”¨æˆ·åˆ—è¡¨ä¸è½¬ç§»ä¸»æŒäºº ======
        function renderUserList(hostId) {
            const container = document.getElementById('userListContainer');
            container.innerHTML = '';
            roomUsers.forEach(id => {
                const isMe = (id === myUserId);
                const isThisUserHost = (id === hostId);
                const name = isMe ? 'æˆ‘' : `æˆå‘˜(${id.substring(0,4)})`;
                const tag = document.createElement('span');
                tag.className = 'user-tag';
                tag.innerHTML = `${name} ${isThisUserHost ? '<span class="host-badge">ä¸»æŒ</span>' : ''}`;
                
                // å¦‚æœæˆ‘æ˜¯ä¸»æŒäººï¼Œç‚¹å‡»åˆ«äººå¯ä»¥è½¬ç§»æƒé™
                if (isHost && !isMe) {
                    tag.title = "ç‚¹å‡»ç§»äº¤ä¸»æŒäºº";
                    tag.onclick = () => {
                        if(confirm(`ç¡®å®šå°†ä¸»æŒäººç§»äº¤ç»™ ${name} å—ï¼Ÿ`)) {
                            socket.emit('transfer_host', id);
                        }
                    };
                }
                container.appendChild(tag);
            });
        }

        function toggleRoomChat() {
            const btn = document.getElementById('hostChatToggleBtn');
            const isCurrentlyEnabled = btn.innerText === "ç¦è¨€å…¨å‘˜";
            socket.emit('toggle_chat', !isCurrentlyEnabled);
        }

        // ====== WebRTC: ä¿®å¤çš„è§†é¢‘ä¸å±å¹•å…±äº« ======
        function createPeerConnection(remoteUserId) {
            if (peerConnections[remoteUserId]) return peerConnections[remoteUserId];
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnections[remoteUserId] = pc;
            pc.onicecandidate = (event) => {
                if (event.candidate) socket.emit('ice-candidate', { target: remoteUserId, from: myUserId, candidate: event.candidate });
            };
            pc.ontrack = (event) => {
                let remoteVideoE = document.getElementById(`video_${remoteUserId}`);
                // å¦‚æœæœªåˆ›å»ºå…ƒç´ ï¼Œåˆ™åˆ›å»ºå¹¶æ’å…¥åˆ°å®¹å™¨ï¼ˆarrangeLayout ä¼šå¤„ç†çœŸå®å¸ƒå±€ï¼‰
                if (!remoteVideoE) {
                    const html = `<div class="video-box" id="box_${remoteUserId}" onclick="togglePin('box_${remoteUserId}')">
                        <video id="video_${remoteUserId}" autoplay playsinline></video>
                        <div class="video-label"><span>æˆå‘˜ (${remoteUserId.substring(0,4)})</span></div>
                    </div>`;
                    // ç›´æ¥ append åˆ° gridï¼›arrangeLayout ä¼šé‡æ–°ç»„ç»‡ä½ç½®
                    document.getElementById('videoGrid').insertAdjacentHTML('beforeend', html);
                    remoteVideoE = document.getElementById(`video_${remoteUserId}`);
                }
                // æ¸…é™¤å¯èƒ½çš„ inline å°ºå¯¸ï¼ˆç”±ä¹‹å‰å¸ƒå±€è®¾å®šï¼‰ï¼Œè®© arrangeLayout æ§åˆ¶å°ºå¯¸
                const boxEl = document.getElementById(`box_${remoteUserId}`);
                if (boxEl) { boxEl.style.width = ''; boxEl.style.height = ''; boxEl.style.display = 'block'; }
                remoteVideoE.srcObject = event.streams[0];
                // æ–°çš„è¿œç«¯è½¨é“åŠ å…¥åï¼Œé‡æ–°æ’å¸ƒå¸ƒå±€ä¿è¯ä¾§æ /ä¸»çª—ä¸€è‡´
                setTimeout(() => arrangeLayout(currentMainId, isLargeMode), 50);
            };
            return pc;
        }

        function closePeerConnection(userId) {
            if (peerConnections[userId]) { peerConnections[userId].close(); delete peerConnections[userId]; }
            const box = document.getElementById(`box_${userId}`);
            if (box) box.remove();
            // è¿œç«¯ç”¨æˆ·ç¦»å¼€åé‡æ–°æ’å¸ƒ
            setTimeout(() => arrangeLayout(currentMainId, isLargeMode), 50);
        }

        // **æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢è½¨é“ä»¥è§£å†³é»‘å±é—®é¢˜**
        function replaceTrackInPeers(newTrack) {
            Object.values(peerConnections).forEach(pc => {
                const sender = pc.getSenders().find(s => s.track && s.track.kind === newTrack.kind);
                if (sender) {
                    sender.replaceTrack(newTrack); // åŠ¨æ€æ›¿æ¢æ­£åœ¨å‘é€çš„è§†é¢‘è½¨é“
                } else if (localStream) {
                    pc.addTrack(newTrack, localStream); // å¦‚æœä¹‹å‰æ²¡æœ‰è§†é¢‘è½¨ï¼Œåˆ™æ·»åŠ 
                }
            });
        }

        async function toggleCam() {
            const btn = document.getElementById('btnCam');
            if (isSharingScreen && !isCamOpen) return alert("è¯·å…ˆåœæ­¢å±å¹•å…±äº«ã€‚");

            if (!isCamOpen) {
                try {
                    console.log('è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    cameraTrack = stream.getVideoTracks()[0];
                    if (!localStream) localStream = new MediaStream([cameraTrack]);
                    else localStream.addTrack(cameraTrack);
                    
                    document.getElementById('localVideo').srcObject = localStream;
                    const lv = document.getElementById('localVideo');
                    if (!lv) {
                        console.error('toggleCam: localVideo å…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•è®¾ç½® srcObject');
                    } else {
                        lv.srcObject = localStream;
                    }
                    replaceTrackInPeers(cameraTrack); // åŒæ­¥ç»™å…¶ä»–äºº
                    
                    isCamOpen = true;
                    btn.innerText = "ğŸ“· å…³é—­æ‘„åƒå¤´"; btn.classList.add('active');
                } catch (err) { alert("æ— æ³•è®¿é—®æ‘„åƒå¤´: " + err.message); }
            } else {
                try {
                    if (cameraTrack) {
                        cameraTrack.enabled = false;
                        cameraTrack.stop();
                        // ä» localStream ä¸­ç§»é™¤è¯¥è½¨é“
                        if (localStream) {
                            try {
                                localStream.removeTrack(cameraTrack);
                            } catch(e) { console.log('ç§»é™¤æœ¬åœ°è½¨é“å¤±è´¥', e); }
                        }
                    }
                } catch(e) { console.log('å…³é—­æ‘„åƒå¤´æ—¶å‡ºé”™', e); }
                isCamOpen = false;
                btn.innerText = "ğŸ“· å¼€å¯æ‘„åƒå¤´"; btn.classList.remove('active');
                // å¦‚æœ localStream ä¸­æ²¡æœ‰è§†é¢‘è½¨é“ï¼Œæ¸…ç©ºæœ¬åœ° video çš„ srcObject
                const lv = document.getElementById('localVideo');
                if (!localStream || (localStream.getVideoTracks && localStream.getVideoTracks().length === 0)) {
                    if (lv) lv.srcObject = null;
                    localStream = localStream && localStream.getAudioTracks && localStream.getAudioTracks().length ? localStream : null;
                } else if (lv) {
                    lv.srcObject = localStream;
                }
            }
        }

        async function toggleScreenShare() {
            const btn = document.getElementById('btnScreen');
            if (isCamOpen && !isSharingScreen) await toggleCam(); // è‡ªåŠ¨å…³æ‘„åƒå¤´

            if (!isSharingScreen) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = stream.getVideoTracks()[0];
                    
                    if (!localStream) localStream = new MediaStream([screenTrack]);
                    
                    document.getElementById('localVideo').srcObject = new MediaStream([screenTrack]);
                    replaceTrackInPeers(screenTrack); // **å®Œç¾ä¿®å¤ï¼šæŠŠå±å¹•æµå‘ç»™æ‰€æœ‰äºº**

                    isSharingScreen = true;
                    btn.innerText = "ğŸ’» åœæ­¢å…±äº«"; btn.classList.add('active');

                    // ç›‘å¬æµè§ˆå™¨è‡ªå¸¦çš„åœæ­¢å…±äº«æŒ‰é’®
                    screenTrack.onended = () => { if(isSharingScreen) toggleScreenShare(); };
                } catch (err) { console.log("å–æ¶ˆå…±äº«"); }
            } else {
                // åœæ­¢å…±äº«
                try {
                    const lv = document.getElementById('localVideo');
                    const src = lv && lv.srcObject;
                    if (src && src.getVideoTracks && src.getVideoTracks().length) {
                        const oldTrack = src.getVideoTracks()[0];
                        if (oldTrack) oldTrack.stop();
                    }
                } catch(e) { console.log('åœæ­¢å…±äº«æ—¶è¯»å– track å¤±è´¥', e); }
                
                isSharingScreen = false;
                btn.innerText = "ğŸ’» å…±äº«å±å¹•"; btn.classList.remove('active');
                const lv2 = document.getElementById('localVideo');
                if (lv2) lv2.srcObject = null;

                // å¦‚æœæ­¤æ—¶åœæ­¢äº†ï¼Œä¸ºäº†ä¸è®©å…¶ä»–äººçœ‹é»‘å±ï¼Œæˆ‘ä»¬éœ€è¦å‘é€ä¸€ä¸ªç©ºçš„/é™éŸ³çš„è½¨é“ï¼Œè¿™é‡Œé€šè¿‡é‡æ–°å¼€å…³æ‘„åƒå¤´é€»è¾‘å¤„ç†æœ€ç¨³å¦¥
            }
        }

        async function toggleMic() {
            if (!localStream) {
                try { localStream = await navigator.mediaDevices.getUserMedia({ audio: true }); } 
                catch(e) { return alert("æ— æ³•è®¿é—®éº¦å…‹é£"); }
            }
            const audioTrack = localStream.getAudioTracks()[0];
            const btn = document.getElementById('btnMic');
            
            if (!isMicOpen) {
                audioTrack.enabled = true;
                replaceTrackInPeers(audioTrack);
                isMicOpen = true;
                btn.innerText = "ğŸ¤ å…³é—­éº¦å…‹é£"; btn.classList.add('active');
            } else {
                audioTrack.enabled = false;
                isMicOpen = false;
                btn.innerText = "ğŸ¤ å¼€å¯éº¦å…‹é£"; btn.classList.remove('active');
            }
        }

        // åˆ‡æ¢/è®¾ç½®ä¸»çª—ï¼ˆç‚¹å‡»è§†é¢‘æ—¶è°ƒç”¨ï¼‰
        function togglePin(boxId) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰ä¸»çª—ï¼šå–æ¶ˆæ”¾å¤§ï¼ˆè¿”å›åˆ°é»˜è®¤å¸ƒå±€ï¼‰
            if (currentMainId === boxId && isLargeMode) {
                isLargeMode = false;
                currentMainId = 'localVideoBox';
                arrangeLayout(currentMainId, isLargeMode);
                return;
            }

            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å½“å‰ä¸»çª—ï¼Œåˆ™å°†å…¶è®¾ä¸ºä¸»çª—å¹¶è¿›å…¥æ”¾å¤§æ¨¡å¼
            if (currentMainId !== boxId) {
                currentMainId = boxId;
                isLargeMode = true;
                arrangeLayout(currentMainId, isLargeMode);
            }
        }

        // é‡æ–°æ’å¸ƒè§†é¢‘ï¼šå°† mainId æ”¾åˆ°å·¦ä¾§ï¼Œå…¶ä»– video-box æ”¾å…¥å³ä¾§ä¾§æ ï¼ˆå…¨éƒ¨æ˜¾ç¤ºï¼Œè¶…å‡ºåˆ™æ»šåŠ¨ï¼‰ï¼Œå¹¶æ ¹æ®ä¸»çª—é«˜åº¦è®¡ç®—ä¾§æ æ¯é¡¹é«˜åº¦ï¼ˆæ¯é¡¹é«˜åº¦è‡³å¤šä¸ºä¸»çª—é«˜åº¦çš„ 1/3ï¼‰
        function arrangeLayout(mainId, large) {
            const grid = document.getElementById('videoGrid');
            // æ”¶é›†æ‰€æœ‰ video-boxï¼ˆåŒ…æ‹¬æœ¬åœ°å’Œè¿œç«¯ï¼‰
            // æ³¨æ„ï¼šåœ¨é‡æ–°ç»„ç»‡ä¹‹å‰å…ˆæŠŠç°æœ‰æ‰€æœ‰å­å…ƒç´ æ”¶é›†å¥½
            const existingBoxes = Array.from(document.querySelectorAll('.video-box'));

            // åœ¨æ¸…ç©º DOM ä¹‹å‰ï¼Œä» existingBoxes ä¸­æ‰¾åˆ°ä¸»çª—å¼•ç”¨ï¼Œé¿å…æ¸…ç©ºåå†é€šè¿‡ getElementById æ‰¾ä¸åˆ°
            let mainBox = existingBoxes.find(b => b.id === mainId) || existingBoxes.find(b => b.id === 'localVideoBox') || existingBoxes[0] || null;

            // æ¸…ç©º gridï¼ˆæˆ‘ä»¬å°†é‡æ–°æ·»åŠ ä¸»çª—ä¸ä¾§æ å†…å®¹ï¼‰
            grid.innerHTML = '';

            // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ä¸»çª—ï¼Œå°±é€€å‡ºï¼ˆé¿å…åç»­å¯¹ null æ“ä½œå¯¼è‡´è„šæœ¬å´©æºƒï¼‰
            if (!mainBox) {
                console.warn('arrangeLayout: æœªæ‰¾åˆ°ä»»ä½• video-boxï¼Œè·³è¿‡å¸ƒå±€');
                return;
            }

            // æ¸…ç†æ‰€æœ‰ video-box çš„å°ºå¯¸å†…è”æ ·å¼ï¼Œè®© CSS ç±»æ§åˆ¶ï¼ˆé¿å…ç´¯ç§¯æ ·å¼å†²çªï¼‰
            existingBoxes.forEach(b => { b.style.width = ''; b.style.height = ''; b.style.display = 'block'; b.classList.remove('large', 'default-main'); });

            // åº”ç”¨ä¸»çª— class
            if (large) mainBox.classList.add('large'); else mainBox.classList.add('default-main');

            // å°†ä¸»çª—æ·»åŠ åˆ° grid
            grid.appendChild(mainBox);

            // æ„å»ºä¾§æ å¹¶æŠŠå…¶å®ƒ video-box åŠ å…¥ä¾§æ ï¼ˆå…¨éƒ¨æ”¾å…¥ï¼Œè¶…è¿‡é«˜åº¦åˆ™æ»šåŠ¨ï¼‰
            const sidebar = document.createElement('div');
            sidebar.className = 'video-sidebar';

            const others = existingBoxes.filter(b => b.id !== mainBox.id);

            if (others.length === 0) sidebar.classList.add('empty');

            // è®¡ç®—ä¸»çª—åƒç´ é«˜åº¦
            const mainHeight = large ? 600 : 400;
            sidebar.style.height = mainHeight + 'px';

            // ä¾§æ æ¯é¡¹æœ€å¤§é«˜åº¦ï¼ˆä¸è¶…è¿‡ä¸»çª—é«˜åº¦çš„ 1/3ï¼‰
            const maxPer = Math.floor(mainHeight / 3);
            // è®¡ç®—å°½å¯èƒ½å‡åˆ†çš„é«˜åº¦ï¼ˆå‡å»é—´éš™ gapï¼Œæ¯ä¸ª gap ä¸º 10pxï¼‰
            const gap = 10;
            const n = others.length || 1;
            let perHeight = Math.floor((mainHeight - (n - 1) * gap) / n);
            if (perHeight > maxPer) perHeight = maxPer;

            // æŒ‰é¡ºåºæŠŠå…¶å®ƒè§†é¢‘æ”¾å…¥ä¾§æ ï¼Œå¹¶è®¾ç½®é«˜åº¦
            others.forEach(b => {
                b.style.width = '100%';
                b.style.height = perHeight + 'px';
                b.style.display = 'block';
                sidebar.appendChild(b);
            });

            grid.appendChild(sidebar);
        }

        // ====== å®Œç¾ä¿®å¤çš„è®¡æ—¶å™¨ (å¸¦æš‚åœåŠŸèƒ½) ======
        let timerInterval;
        let totalSeconds = 0; 
        let isTimerRunning = false;
        let isTimerPaused = false; // æ–°å¢æš‚åœçŠ¶æ€

        function updateDisplay(sec) {
            document.getElementById('timeDisplay').innerText = 
                `${Math.floor(sec / 60).toString().padStart(2, '0')}:${(sec % 60).toString().padStart(2, '0')}`;
        }

        function startStopwatch() {
            clearInterval(timerInterval);
            totalSeconds = 0;
            isTimerRunning = true; isTimerPaused = false;
            document.getElementById('timerStatus').innerText = "æ­£è®¡æ—¶ä¸­...";
            document.getElementById('btnPause').style.display = 'inline-block';
            document.getElementById('btnPause').innerText = 'æš‚åœ';
            
            timerInterval = setInterval(() => {
                if (!isTimerPaused) { // æš‚åœæ—¶ä¸æ”¹å˜ç§’æ•°
                    totalSeconds++;
                    updateDisplay(totalSeconds);
                }
            }, 1000);
        }

        function startPomodoro() {
            clearInterval(timerInterval);
            const mins = parseInt(document.getElementById('focusTime').value) || 25;
            totalSeconds = mins * 60;
            isTimerRunning = true; isTimerPaused = false;
            
            document.getElementById('timerStatus').innerText = "ğŸ”¥ ä¸“æ³¨ä¸­...";
            document.getElementById('btnPause').style.display = 'inline-block';
            document.getElementById('btnPause').innerText = 'æš‚åœ';
            updateDisplay(totalSeconds);
            
            timerInterval = setInterval(() => {
                if (!isTimerPaused) {
                    if (totalSeconds > 0) {
                        totalSeconds--;
                        updateDisplay(totalSeconds);
                    } else {
                        clearInterval(timerInterval);
                        alert("ä¸“æ³¨ç»“æŸï¼");
                    }
                }
            }, 1000);
        }

        // æ–°å¢ï¼šæš‚åœä¸ç»§ç»­é€»è¾‘
        function togglePauseTimer() {
            if (!isTimerRunning) return;
            isTimerPaused = !isTimerPaused;
            const btn = document.getElementById('btnPause');
            const status = document.getElementById('timerStatus');
            
            if (isTimerPaused) {
                btn.innerText = "ç»§ç»­";
                // è·å–æ ¹å…ƒç´ å®šä¹‰çš„ CSS å˜é‡å€¼å¹¶ä½œä¸ºèƒŒæ™¯è‰²ä½¿ç”¨
                const rootStyle = getComputedStyle(document.documentElement);
                btn.style.background = rootStyle.getPropertyValue('--primary-color') || '#52c41a';
                status.innerText = "â¸ï¸ å·²æš‚åœ";
            } else {
                btn.innerText = "æš‚åœ";
                btn.style.background = "#faad14";
                status.innerText = "è®¡æ—¶ä¸­...";
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false; isTimerPaused = false;
            document.getElementById('timerStatus').innerText = "å·²åœæ­¢";
            document.getElementById('btnPause').style.display = 'none';
        }

        // ====== ä»»åŠ¡ä¸èŠå¤© (åŸæœ‰é€»è¾‘è¡¥é½) ======
        function createList(name) {
            const listId = `list_${Date.now()}`;
            const html = `
                <div style="margin-bottom:10px; border:1px solid #eee; padding:10px; border-radius:8px;">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ“‚ ${name || 'æ–°æ¸…å•'}</div>
                    <div style="display:flex; gap:5px;"><input type="text" id="taskInput_${listId}"><button onclick="addTask('${listId}')">æ·»åŠ </button></div>
                    <div id="tasks_${listId}" style="margin-top:10px;"></div>
                </div>`;
            document.getElementById('listsContainer').insertAdjacentHTML('beforeend', html);
        }
        function addTask(listId) {
            const val = document.getElementById(`taskInput_${listId}`).value;
            if(!val) return;
            const taskId = `task_${Date.now()}`;
            document.getElementById(`tasks_${listId}`).insertAdjacentHTML('beforeend', 
                `<div class="task-item" id="${taskId}"><label><input type="checkbox" onclick="document.getElementById('${taskId}').classList.toggle('completed')"> <span>${val}</span></label></div>`);
            document.getElementById(`taskInput_${listId}`).value = '';
        }

        function sendReflection() {
            const input = document.getElementById('reflectionInput');
            const msg = input.value.trim();
            if (!msg) return;
            const timeStr = new Date().toLocaleTimeString();
            appendMessage('æˆ‘', msg, timeStr, true);
            if(socket) socket.emit('chat_message', { userName: isHost ? 'ğŸ‘‘ä¸»æŒäºº(æˆ‘)' : `æˆå‘˜(${myUserId.substring(0,4)})`, message: msg, time: timeStr });
            input.value = '';
        }

        function appendMessage(user, msg, time, isSelf) {
            const box = document.getElementById('chatBox');
            box.insertAdjacentHTML('beforeend', `<div class="message ${isSelf ? 'self' : ''}"><div class="msg-meta">${user} ${time}</div><div>${msg}</div></div>`);
            box.scrollTop = box.scrollHeight;
        }
        const _refInput = document.getElementById('reflectionInput');
        if (_refInput) _refInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendReflection(); });
    </script>
</body>
</html>